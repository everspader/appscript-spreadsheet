<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

    <title>Hello, world!</title>
    <style>
      .form-group input {
        box-shadow: none;
      }
    </style>
  </head>
  <body>
    <div class="container pt-3" id="userform">
      <div class="form-group" >
        <label for="fullname">Full Name</label>
        <input type="text" class="form-control form-control-sm" id="name" required>
        <div class="invalid-feedback">
          Please enter your full name.
        </div>
      </div>
      <div class="form-group">
        <label for="city">City</label>
        <select class="form-control form-control-sm" id="city-list" required></select>
        <div class="invalid-feedback">
          Please select a city from the list.
        </div>
      </div>
      <div class="form-group">
        <label for="company">Company</label>
        <select class="form-control form-control-sm" id="company-list" required></select>
        <div class="invalid-feedback">
          Please select a company from the list.
        </div>
      </div>
      <div class="form-group">
        <label for="email">Email</label>
        <input type="email" class="form-control form-control-sm" id="email" required>
        <div class="invalid-feedback">
          Please enter a valid e-mail.
        </div>
      </div>
      <div class="form-group">
        <label for="date">Date</label>
        <input type="date" class="form-control form-control-sm" id="date" required>
        <div class="invalid-feedback">
          Please select a valid date.
        </div>
      </div>
      <div class="form-group">
        <label for="phone-number">Phone Number</label>
        <input type="text" class="form-control form-control-sm" id="phone-number" pattern="^\d{5}-\d{4}$"> <!-- regex pattern-->
        <div class="invalid-feedback">
          Please enter a valid order number
        </div>
      </div>
      <div class="form-group">
        <label for="comments">Comments</label>
        <textarea class="form-control" id="comments" rows="3" required minlength="5" maxlength="100"></textarea>
      </div>
      <button id="btn-submit" class="btn btn-dark btn-dark-sm">Submit</button>
    </div>

    <!-- Notifications of fail/success -->
    <div id="notification" class="mt-3">
      <div style="background-color: salmon" id="error-notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-delay="3000">
        <div class="toast-header">
          <strong class="mr-auto">Error</strong>
          <small>Notification</small>
          <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="toast-body">
          One or more required fields were not completed.
        </div>
      </div>
      <div id="success-notification" class="toast" role="alert" aria-live="assertive" aria-atomic="true" data-delay="3000">
        <div class="toast-header">
          <strong class="mr-auto">Success</strong>
          <small>Notification</small>
          <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="toast-body">
          Data added to sheet.
        </div>
      </div>
    </div>


    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>
    <script>
      var arrayOfValues;

      function afterButtonClick(){

        if (validateForm()){
          var nameInput = document.getElementById('name');
          var cityInput = document.getElementById('city-list');
          var companyInput = document.getElementById('company-list');
          var emailInput = document.getElementById('email');
          var dateInput = document.getElementById('date');
          var phoneNumberInput = document.getElementById('phone-number');
          var commentsText = document.getElementById('comments');
          var data = {
            name: nameInput.value,
            city: cityInput.value,
            company: companyInput.value,
            email: emailInput.value,
            date: dateInput.value,
            phoneNumber: phoneNumberInput.value,
            comments: commentsText.value,
            };
          google.script.run.withSuccessHandler(afterSubmit).appendData(data);
          // google.script.run.withSuccessHandler(afterSubmit).appendColumns();
        } else {
          $('#error-notification').toast('show')
        }
      }

      function afterSubmit(e) {
        clearFields([
          'name', 'city-list', 'company-list', 'email', 'date', 'phone-number', 'comments'
        ]);

        $('#success-notification').toast('show')
      }

      function clearFields(fields) {
        fields.forEach(function(field){
          var el = document.getElementById(field);
          el.value = "";
        });
      }

      function afterSidebarLoads(){
        google.script.run.withSuccessHandler(afterDropdownArrayReturned).getDropdownArray();
      }

      function validateForm(){
        var fieldsToValidate = document.querySelectorAll("#userform input, #userform textarea");

        Array.prototype.forEach.call(fieldsToValidate, function(el){
          if(el.checkValidity()) {
            el.classList.remove("is-invalid");
          } else {
            el.classList.add("is-invalid");
          }
        });

        return Array.prototype.every.call(fieldsToValidate, function(el){
          return el.checkValidity();
        });
      }
      function addUniqueOptionsToDropdownList(element, arrayOfArrays, index){
        var currentlyAdded = [];

        element.innerHTML = '<option></option>';
        arrayOfArrays.forEach(function(r) {
          if(currentlyAdded.indexOf(r[index]) === -1){
            var option = document.createElement("option");
            option.textContent = r[index];
            element.appendChild(option);
            currentlyAdded.push(r[index]);
          }
        });
      }

      function afterDropdownArrayReturned(arrayOfArrays) {
        arrayOfValues = arrayOfArrays.filter(function(r){return true});
        var item = document.getElementById("city-list");
        addUniqueOptionsToDropdownList(item, arrayOfValues, 0)
      }

      function afterFirstDropdownChanged(){
        var item = document.getElementById("company-list");
        var city = document.getElementById("city-list").value;
        var filteredArrayOfValues = arrayOfValues.filter(function(r){return r[0] === city});
        addUniqueOptionsToDropdownList(item, filteredArrayOfValues, 1)
      }

      document.getElementById('btn-submit').addEventListener('click', afterButtonClick);
      document.getElementById('city-list').addEventListener('change', afterFirstDropdownChanged);
      document.addEventListener("DOMContentLoaded", afterSidebarLoads);

    </script>
  </body>
</html>